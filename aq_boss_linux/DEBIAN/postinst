#!/bin/bash
set -e

SERVICE_NAME="aq_boss_linux.service"
USB_RULE="/etc/udev/rules.d/80-aq-boss-usb.rules"
ACTION="$1"

echo "[AQ Boss Linux] Running post-install setup (action: $ACTION)..."

# Skip service/udev reloads if this is an upgrade
if [ "$ACTION" = "upgrade" ]; then
    echo "Upgrade detected â€” skipping service and udev setup."
else
    # Step 1: Reload udev if rules exist
    if [ -f "$USB_RULE" ] && command -v udevadm >/dev/null 2>&1; then
        echo "Reloading udev rules..."
        udevadm control --reload-rules || true
        udevadm trigger || true
    fi

    # Step 2: Reload systemd if present
    if pidof systemd >/dev/null 2>&1 && command -v systemctl >/dev/null 2>&1; then
        echo "Reloading systemd daemon..."
        systemctl daemon-reload || true
    fi
fi

# Step 3: Set permissions for updater script (always safe)
if [ -f "/opt/boss-local/updater/usb_update_check.py" ]; then
    chmod 755 /opt/boss-local/updater/usb_update_check.py
    chown root:root /opt/boss-local/updater/usb_update_check.py
fi

# Step 4: Optionally restart main service only if systemd exists
if pidof systemd >/dev/null 2>&1 && command -v systemctl >/dev/null 2>&1; then
    if systemctl list-units --all | grep -q "$SERVICE_NAME"; then
        echo "Restarting $SERVICE_NAME..."
        systemctl restart "$SERVICE_NAME" >/dev/null 2>&1 || true
    fi
fi

echo "[AQ Boss Linux] Post-install setup complete."
exit 0
